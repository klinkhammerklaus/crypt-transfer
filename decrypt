#!/usr/bin/env bash
set -euo pipefail

BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
OUT_DIR="$BASE_DIR/encrypted"
DEC_DIR="$BASE_DIR/decrypted"
KEY_FILE="$BASE_DIR/k.txt"

mkdir -p "$DEC_DIR"

if [[ ! -f "$KEY_FILE" ]]; then
  echo "Key file not found: $KEY_FILE"
  exit 1
fi

if [[ ! -s "$KEY_FILE" ]]; then
  echo "Key file is empty: $KEY_FILE"
  exit 1
fi

PASS="$(cat "$KEY_FILE")"

shopt -s nullglob
found=0

for f in "$OUT_DIR"/*.enc; do
  [[ -f "$f" ]] || continue
  found=1

  name="$(basename "$f")"
  out="$DEC_DIR/${name%.enc}"

  openssl enc -d -aes-256-cbc -pbkdf2 -iter 200000     -in "$f" -out "$out" -pass "pass:$PASS"

  echo "ðŸ”“ $name -> $(basename "$out")"
done

if [[ "$found" -eq 0 ]]; then
  echo "No .enc files found in $OUT_DIR"
fi
