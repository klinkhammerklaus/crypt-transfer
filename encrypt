#!/usr/bin/env bash
set -euo pipefail

BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
IN_DIR="$BASE_DIR/input"
OUT_DIR="$BASE_DIR/encrypted"
KEY_FILE="$BASE_DIR/k.txt"

mkdir -p "$IN_DIR" "$OUT_DIR"

if [[ ! -f "$KEY_FILE" ]]; then
  echo "Key file not found: $KEY_FILE"
  exit 1
fi

if [[ ! -s "$KEY_FILE" ]]; then
  echo "Key file is empty: $KEY_FILE"
  exit 1
fi

PASS="$(cat "$KEY_FILE")"

shopt -s nullglob
found=0

for f in "$IN_DIR"/*; do
  [[ -f "$f" ]] || continue
  found=1

  name="$(basename "$f")"
  out="$OUT_DIR/${name}.enc"

  # AES-256-CBC + PBKDF2 (strong key derivation)
  openssl enc -aes-256-cbc -salt -pbkdf2 -iter 200000     -in "$f" -out "$out" -pass "pass:$PASS"

  echo "âœ… $name -> $(basename "$out")"
done

if [[ "$found" -eq 0 ]]; then
  echo "No files found in $IN_DIR"
fi
